name: Multi-arch build (wheels + debs)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [aarch64, arm, i686, x86_64]   # add more if needed (aarch32 maps to 'arm')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for docker multiarch)
        uses: docker/setup-qemu-action@v2

      - name: Set up docker buildx
        uses: docker/setup-buildx-action@v2

      - name: Prepare builder image mapping
        id: mapping
        run: |
          case "${{ matrix.arch }}" in
            aarch64) echo "termux_image=ghcr.io/termux/termux-docker:build-aarch64" > mapping.txt ;;
            arm)     echo "termux_image=ghcr.io/termux/termux-docker:build-arm" > mapping.txt ;;
            i686)    echo "termux_image=ghcr.io/termux/termux-docker:build-i686" > mapping.txt ;;
            x86_64)  echo "termux_image=ghcr.io/termux/termux-docker:build-x86_64" > mapping.txt ;;
            *)       echo "termux_image=ghcr.io/termux/termux-docker:build-aarch64" > mapping.txt ;;
          esac
          cat mapping.txt
        shell: bash

      - name: Load mapping
        run: |
          source mapping.txt
          echo "TERMUX_IMAGE=${termux_image}" >> $GITHUB_ENV

      - name: Run termux builder container
        run: |
          mkdir -p out/${{ matrix.arch }}
          # copy repository into container and run package build scripts
          docker run --rm -v "${{ github.workspace }}":/workspace -w /workspace ${TERMUX_IMAGE} /bin/bash -lc "\
            set -euo pipefail; \
            apt-get update || true; \
            # install build essentials in container (if required by the builder image)
            if command -v apt-get >/dev/null 2>&1; then apt-get update && apt-get install -y python3 python3-pip python3-dev build-essential wget git cmake gfortran pkg-config; fi; \
            /workspace/scripts/build_wheel.sh /workspace /workspace/out/${{ matrix.arch }} ${matrix.arch}"
        env:
          CI: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.arch }}
          path: out/${{ matrix.arch }}/*.whl
